<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interval Timer</title>
  <style>
    :root{
      --bg:#0b0b0b; --panelBorder:#2b2b2b; --muted:#9a9a9a; --text:#e8e8e8;
      --emerald:#34d399; --sky:#38bdf8; --amber:#fbbf24; --violet:#a78bfa; --accent:#22c55e;
      --btn:#232323; --btnHover:#2d2d2d; --shadow:0 10px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));
      border:1px solid var(--panelBorder); border-radius:24px; padding:24px; box-shadow:var(--shadow);
      width:100%; max-width:880px
    }
    .titleRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-weight:700;font-size:28px;letter-spacing:.2px}
    .iconbtn{padding:8px;border-radius:12px;background:#1f1f1f;border:1px solid #2b2b2b;cursor:pointer}
    .centerCol{display:flex;flex-direction:column;align-items:center;gap:16px}
    .btnRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .btn{background:var(--btn);border:1px solid var(--panelBorder);color:var(--text);padding:10px 14px;border-radius:14px;cursor:pointer}
    .btn:hover{background:var(--btnHover)}
    .btn.primary{background:var(--accent);color:#0b0b0b;border-color:#16a34a}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.warn{background:var(--amber);color:#0b0b0b;border-color:#d6a416}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .fieldGrid{display:grid;gap:12px}
    @media (min-width:620px){ .fieldGrid{grid-template-columns:repeat(4,1fr)} }
    .field label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    .field input{width:100%;padding:10px 12px;border-radius:14px;background:#1a1a1a;border:1px solid var(--panelBorder);color:var(--text);outline:none}
    .field input:focus{border-color:#3b82f6;box-shadow:0 0 0 6px rgba(59,130,246,.15)}
    .ringWrap{position:relative}
    .ringText{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:6px}
    .phase{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.15em}
    .time{font-size:80px;line-height:1;font-variant-numeric:tabular-nums;font-weight:800}
    .round{font-size:13px;color:var(--muted)}
    .pulse{animation:pulse .6s ease}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    #timerPanel{display:block}
    #settingsPanel{display:none}
    .presetTimerRow{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- TIMER PANEL -->
      <div id="timerPanel">
        <div class="titleRow">
          <div class="title">Interval Timer</div>
          <button id="openSettings" class="iconbtn" aria-label="Open settings" title="Settings">
            <!-- Gear icon with high-contrast stroke -->
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                 viewBox="0 0 24 24" fill="none" stroke="var(--text)" stroke-width="2">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 21 12h.09a2 2 0 1 1 0 4H21a1.65 1.65 0 0 0-1.6-.99Z"/>
            </svg>
          </button>
        </div>

        <div class="centerCol">
          <div class="ringWrap" id="ringWrap" aria-live="polite">
            <svg id="ring" width="300" height="300" style="transform:rotate(-90deg);display:block">
              <circle cx="150" cy="150" r="142" stroke="#2b2b2b" stroke-width="16" fill="none"></circle>
              <circle id="prog" cx="150" cy="150" r="142" stroke="#34d399" stroke-width="16" stroke-linecap="round" fill="none"></circle>
            </svg>
            <div class="ringText">
              <div class="phase" id="phaseLabel">work</div>
              <div class="time" id="timeLabel">0:00</div>
              <div class="round" id="roundLabel">Round 1 / 3</div>
            </div>
          </div>
          <div class="btnRow">
            <button class="btn primary" id="startBtn">Start</button>
            <button class="btn warn" id="pauseBtn" style="display:none">Pause</button>
            <button class="btn" id="resetBtn">Reset</button>
            <button class="btn" id="backBtn">Back</button>
            <button class="btn" id="skipBtn">Skip</button>
          </div>
          <div class="muted" id="progressNote"></div>

          <!-- Presets in Timer Panel (bottom, centered) -->
          <div class="presetTimerRow" aria-label="Presets">
            <span class="muted">Presets:</span>
            <button class="btn" id="preset1_timer">Wall Sits</button>
            <button class="btn" id="preset2_timer">Planks</button>
          </div>
        </div>
      </div>

      <!-- SETTINGS PANEL -->
      <div id="settingsPanel">
        <div class="titleRow">
          <div class="title">Settings</div>
          <button id="closeSettings" class="iconbtn" aria-label="Close settings" title="Close">
            <!-- X icon with high-contrast stroke -->
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                 viewBox="0 0 24 24" fill="none" stroke="var(--text)" stroke-width="2">
              <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="fieldGrid" style="margin-bottom:12px">
          <div class="field">
            <label>Warm-up (sec)</label>
            <input type="number" id="warmupInput" min="0" max="600">
          </div>
          <div class="field">
            <label>Work (sec)</label>
            <input type="number" id="workInput" min="0" max="3600">
          </div>
          <div class="field">
            <label>Rest (sec)</label>
            <input type="number" id="restInput" min="0" max="3600">
          </div>
          <div class="field">
            <label>Rounds</label>
            <input type="number" id="roundsInput" min="1" max="200">
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin:12px 0">
          <span class="muted">Sound</span>
          <button id="soundBtn" class="btn">On</button>
        </div>

        <div class="muted" style="line-height:1.5">
          Starts with a warm-up (beeps at 3–2–1), then cycles Work/Rest (beeps at 3–2–1 of REST).
          After the last WORK round, the timer completes immediately with an upbeat sound.
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = "interval-timer:offline-v6";

    const $ = (sel, el=document) => el.querySelector(sel);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const toSeconds = (v) => { const n = Number(v); return Number.isFinite(n) && n >= 0 ? Math.round(n) : 0; };
    const fmt = (s) => { s = Math.max(0, Math.round(s)); const m = Math.floor(s/60), sec = s%60; return m+":"+String(sec).padStart(2,"0"); };

    // Load state
    const saved = (() => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } })();
    let work = saved.work ?? 20;
    let rest = saved.rest ?? 10;
    let rounds = saved.rounds ?? 3;
    let warmup = saved.warmup ?? 5;
    let soundOn = saved.soundOn ?? true;

    // Timer state
    let running = false;
    let phase = "work"; // warmup|work|rest|done
    let round = 1;
    let remaining = work;
    let lastTick = null;
    let lastWhole = null;
    let rafId = null;

    // --- Screen Wake Lock (keep display on while running) ---
    let wakeLock = null;
    async function acquireWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => { wakeLock = null; });
        }
      } catch (err) {
        console.debug('WakeLock error:', err && err.name);
      }
    }
    async function releaseWakeLock() {
      try {
        if (wakeLock) { await wakeLock.release(); wakeLock = null; }
      } catch {}
    }
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && running) acquireWakeLock();
    });

    // Audio (WebAudio) with unlock on user gesture
    let audioCtx = null;
    function ensureCtx(){
      if(!audioCtx){
        const Ctx = window.AudioContext || window.webkitAudioContext;
        audioCtx = new Ctx();
      }
      if(audioCtx.state === "suspended") audioCtx.resume();
      return audioCtx;
    }
    function unlockAudio(){
      try{
        const ctx = ensureCtx();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        g.gain.value = 0.0001;
        osc.connect(g).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.01);
      }catch{}
    }
    function beep(freq=880, ms=120){
      if(!soundOn) return;
      try{
        const ctx = ensureCtx();
        const t0 = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.00001, t0);
        gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.00001, t0 + ms/1000);
        osc.connect(gain).connect(ctx.destination);
        osc.start(t0);
        osc.stop(t0 + ms/1000);
      }catch{}
    }
    function finishSound(){ beep(784,180); setTimeout(()=>beep(880,180),170); setTimeout(()=>beep(988,260),340); }

    // Elements
    const openSettingsBtn = $("#openSettings");
    const presetRow = $(".presetTimerRow");
    const prog = $("#prog");
    const timeLabel = $("#timeLabel");
    const phaseLabel = $("#phaseLabel");
    const roundLabel = $("#roundLabel");
    const progressNote = $("#progressNote");
    const startBtn = $("#startBtn");
    const pauseBtn = $("#pauseBtn");
    const resetBtn = $("#resetBtn");
    const skipBtn  = $("#skipBtn");
    const backBtn  = $("#backBtn");
    const timerPanel = $("#timerPanel");
    const settingsPanel = $("#settingsPanel");
    const warmupInput = $("#warmupInput");
    const workInput = $("#workInput");
    const restInput = $("#restInput");
    const roundsInput = $("#roundsInput");
    const soundBtn = $("#soundBtn");

    $("#openSettings").addEventListener("click", () => { unlockAudio(); showSettings(true); });
    $("#closeSettings").addEventListener("click", () => showSettings(false));

    // Timer panel presets
    $("#preset1_timer").addEventListener("click", () => { applyPreset(30,30,3); });
    $("#preset2_timer").addEventListener("click", () => { applyPreset(20,20,3); });

    // Sound toggle
    soundBtn.addEventListener("click", () => { soundOn = !soundOn; soundBtn.textContent = soundOn ? "On" : "Off"; save(); });

    // Inputs initial + handlers
    warmupInput.value = warmup;
    workInput.value = work;
    restInput.value = rest;
    roundsInput.value = rounds;

    warmupInput.addEventListener("input", e => { warmup = clamp(toSeconds(e.target.value), 0, 600); if(!running && phase==="warmup") remaining = warmup; save(); updateUI(); });
    workInput.addEventListener("input", e => { work   = clamp(toSeconds(e.target.value), 0, 3600); if(!running && phase==="work")   remaining = work;   save(); updateUI(); });
    restInput.addEventListener("input", e => { rest   = clamp(toSeconds(e.target.value), 0, 3600); if(!running && phase==="rest")   remaining = rest;   save(); updateUI(); });
    roundsInput.addEventListener("input", e => { rounds = clamp(toSeconds(e.target.value), 1, 200); save(); updateUI(); });

    function save(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify({work,rest,rounds,warmup,soundOn})); } catch {} }

    // Ring circumference
    const R = 142, C = 2 * Math.PI * R;
    prog.setAttribute("stroke-dasharray", String(C));
    prog.setAttribute("stroke-dashoffset", String(C));

    function updateUI(){
      // Colors by phase
      prog.setAttribute("stroke", phase==="work" ? "#34d399" : phase==="rest" ? "#38bdf8" : phase==="warmup" ? "#fbbf24" : "#a78bfa");
      phaseLabel.textContent = phase === "done" ? "complete" : phase;
      timeLabel.textContent = fmt(remaining);
      roundLabel.textContent = phase !== "warmup" ? `Round ${round} / ${rounds}` : "Warm-up";

      const dur = phase==="warmup" ? warmup : phase==="work" ? work : phase==="rest" ? rest : 1;
      const progFrac = 1 - Math.max(0, Math.min(remaining, Math.max(1,dur))) / Math.max(1,dur);
      prog.setAttribute("stroke-dashoffset", String(C * (1 - progFrac)));

      startBtn.style.display = running ? "none" : "";
      pauseBtn.style.display = running ? "" : "none";
      backBtn.disabled = (round===1 && phase==="work");

      // Hide gear & presets while running
      if (openSettingsBtn) openSettingsBtn.style.display = running ? "none" : "";
      if (presetRow) presetRow.style.display = running ? "none" : "";

      const total = warmup + work*rounds + rest*Math.max(0, rounds-1);
      const pct = Math.round(progFrac*100);
      progressNote.textContent = `Progress: ${pct}% • Total: ${fmt(total)}`;
    }

    function showSettings(show){
      if(show){ timerPanel.style.display="none"; settingsPanel.style.display="block"; }
      else { settingsPanel.style.display="none"; timerPanel.style.display="block"; }
    }

    function start(){
      unlockAudio();
      if (phase === "done") reset();
      acquireWakeLock(); // keep screen on
      phase = "warmup"; remaining = warmup; running = true; lastTick = null; lastWhole = null;
      updateUI();
      loop();
    }
    function pause(){
      running = false;
      releaseWakeLock();
      cancelAnimationFrame(rafId);
      updateUI();
    }
    function reset(){
      running = false;
      releaseWakeLock();
      phase = "work"; round = 1; remaining = work; lastTick=null; lastWhole=null;
      cancelAnimationFrame(rafId);
      updateUI();
    }
    function skip(){
      unlockAudio();
      if (phase === "warmup"){ phase="work"; remaining=work; updateUI(); return; }
      if (phase === "work" && rest>0 && round < rounds){ phase="rest"; remaining=rest; updateUI(); }
      else { advanceRound(); }
    }
    function back(){
      unlockAudio();
      if (phase === "rest"){ phase="work"; remaining=work; updateUI(); return; }
      if (phase === "work"){
        if (round > 1){
          round -= 1;
          if (rest>0){ phase="rest"; remaining=rest; } else { phase="work"; remaining=work; }
          updateUI();
        } else {
          phase="warmup"; remaining=warmup; updateUI();
        }
      }
    }

    function applyPreset(w, r, n){
      work = w; rest = r; rounds = n;
      workInput.value = w; restInput.value = r; roundsInput.value = n;
      reset();
      save();
    }

    function advanceRound(){
      if (round < rounds){
        round += 1;
        phase = "work"; remaining=work;
      } else {
        finishSound();
        phase = "done"; running = false; remaining = 0;
        releaseWakeLock(); // release on completion
      }
      updateUI();
    }

    function handlePhaseEdge(){
      if (phase === "warmup"){
        beep(1000,220);
        phase = "work"; remaining = work;
      } else if (phase === "work"){
        if (round >= rounds){
          finishSound(); phase="done"; running=false; remaining=0;
          releaseWakeLock();
        } else if (rest > 0){
          beep(1175,200);
          phase="rest"; remaining=rest;
        } else {
          advanceRound(); return;
        }
      } else if (phase === "rest"){
        beep(880,200);
        advanceRound(); return;
      }
      updateUI();
    }

    function loop(t){
      if (!running) return;
      if (!lastTick) lastTick = t;
      const dt = (t - lastTick) || 16;
      lastTick = t;

      remaining = Math.max(0, remaining - dt/1000);

      // Beeps at 3-2-1 for REST & WARMUP
      const whole = Math.max(0, Math.ceil(remaining));
      if ((phase === "rest" || phase === "warmup") && lastWhole !== whole){
        if ([3,2,1].includes(whole)) beep(750,140);
        lastWhole = whole;
      } else if (phase !== "rest" && phase !== "warmup") {
        lastWhole = whole;
      }

      if (remaining <= 0.0001){
        handlePhaseEdge();
      }

      // Smooth ring + time
      const dur = phase==="warmup" ? warmup : phase==="work" ? work : phase==="rest" ? rest : 1;
      const progFrac = 1 - Math.max(0, Math.min(remaining, Math.max(1,dur))) / Math.max(1,dur);
      prog.setAttribute("stroke-dashoffset", String(C*(1-progFrac)));
      timeLabel.textContent = fmt(remaining);

      rafId = requestAnimationFrame(loop);
    }

    // Wire buttons
    startBtn.addEventListener("click", start);
    pauseBtn.addEventListener("click", pause);
    resetBtn.addEventListener("click", reset);
    skipBtn.addEventListener("click", skip);
    backBtn.addEventListener("click", back);

    // Init UI
    updateUI();
  })();
  </script>
</body>
</html>
